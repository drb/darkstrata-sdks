# DarkStrata Technology Add-on - Saved Searches Configuration
# Includes threat intel KV store population and correlation searches

# =============================================================================
# THREAT INTEL KV STORE POPULATION
# These searches populate ES Threat Intel Framework lookups from DarkStrata data
# =============================================================================

#
# Populate Email Intelligence KV Store
# Extracts compromised email addresses from observed-data events
#
[DarkStrata - Populate Email Intel]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = */15 * * * *
description = Populates the DarkStrata email intelligence KV store from observed-data events. Runs every 15 minutes.
dispatch.earliest_time = -20m@m
dispatch.latest_time = now
enableSched = 1
search = sourcetype="darkstrata:stix:observed-data" \
    | spath path="objects.0.account_type" output=account_type \
    | where account_type="email" \
    | spath path="objects.0.account_login" output=email \
    | spath path="objects.1.value" output=domain \
    | spath path="labels{}" output=labels \
    | eval source_type=if(match(mvjoin(labels,","),"source:malware"),"malware","breach") \
    | eval flow_direction=if(match(mvjoin(labels,","),"flow:inbound"),"inbound","outbound") \
    | eval threat_key=email \
    | eval description="Compromised credential: ".email." on ".domain." (source: ".source_type.", flow: ".flow_direction.")" \
    | eval weight=case(match(mvjoin(labels,","),"severity-critical"),100, match(mvjoin(labels,","),"severity-high"),80, match(mvjoin(labels,","),"severity-medium"),60, match(mvjoin(labels,","),"severity-low"),40, 1=1, 20) \
    | stats earliest(_time) as first_seen, latest(_time) as last_seen, values(domain) as domains, max(weight) as weight by email, threat_key, source_type, flow_direction \
    | eval description="Compromised credential found in ".source_type." (".flow_direction." flow). Affected services: ".mvjoin(domains,", ") \
    | table email, description, threat_key, weight, first_seen, last_seen, source_type, flow_direction \
    | outputlookup append=t darkstrata_email_intel

#
# Populate Domain Intelligence KV Store
# Extracts domains associated with credential exposures
#
[DarkStrata - Populate Domain Intel]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = */15 * * * *
description = Populates the DarkStrata domain intelligence KV store. Runs every 15 minutes.
dispatch.earliest_time = -20m@m
dispatch.latest_time = now
enableSched = 1
search = sourcetype="darkstrata:stix:observed-data" \
    | spath path="objects.1.value" output=domain \
    | spath path="labels{}" output=labels \
    | eval source_type=if(match(mvjoin(labels,","),"source:malware"),"malware","breach") \
    | eval threat_key=domain \
    | eval weight=case(match(mvjoin(labels,","),"severity-critical"),100, match(mvjoin(labels,","),"severity-high"),80, match(mvjoin(labels,","),"severity-medium"),60, match(mvjoin(labels,","),"severity-low"),40, 1=1, 20) \
    | stats earliest(_time) as first_seen, latest(_time) as last_seen, dc(objects.0.account_login) as affected_users, max(weight) as weight by domain, threat_key, source_type \
    | eval description="Domain associated with ".affected_users." compromised credentials (source: ".source_type.")" \
    | table domain, description, threat_key, weight, first_seen, last_seen \
    | outputlookup append=t darkstrata_domain_intel

#
# Populate User Intelligence KV Store
# Extracts compromised usernames (non-email identifiers)
#
[DarkStrata - Populate User Intel]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = */15 * * * *
description = Populates the DarkStrata user intelligence KV store. Runs every 15 minutes.
dispatch.earliest_time = -20m@m
dispatch.latest_time = now
enableSched = 1
search = sourcetype="darkstrata:stix:observed-data" \
    | spath path="objects.0.account_type" output=account_type \
    | spath path="objects.0.account_login" output=user \
    | spath path="objects.1.value" output=domain \
    | spath path="labels{}" output=labels \
    | eval source_type=if(match(mvjoin(labels,","),"source:malware"),"malware","breach") \
    | eval flow_direction=if(match(mvjoin(labels,","),"flow:inbound"),"inbound","outbound") \
    | eval threat_key=user \
    | eval email=if(account_type="email",user,null()) \
    | eval weight=case(match(mvjoin(labels,","),"severity-critical"),100, match(mvjoin(labels,","),"severity-high"),80, match(mvjoin(labels,","),"severity-medium"),60, match(mvjoin(labels,","),"severity-low"),40, 1=1, 20) \
    | stats earliest(_time) as first_seen, latest(_time) as last_seen, values(domain) as domains, max(weight) as weight, values(email) as email by user, threat_key, source_type, flow_direction \
    | eval description="Compromised user credential (source: ".source_type.", flow: ".flow_direction.")" \
    | table user, description, threat_key, weight, first_seen, last_seen, email \
    | outputlookup append=t darkstrata_user_intel


# =============================================================================
# CORRELATION SEARCHES FOR ENTERPRISE SECURITY
# These create notable events when threat conditions are detected
# =============================================================================

#
# Critical/High Severity Credential Exposure
# Triggers when new critical or high severity credentials are detected
#
[DarkStrata - Critical Credential Exposure Detected]
action.correlationsearch.enabled = 1
action.correlationsearch.label = DarkStrata - Critical Credential Exposure
action.email.useNSSubject = 1
action.notable = 1
action.notable.param.drilldown_name = View in DarkStrata
action.notable.param.drilldown_search = sourcetype="darkstrata:stix:observed-data" | search user="$user$"
action.notable.param.rule_description = A critical or high severity credential exposure was detected by DarkStrata. This indicates a compromised credential that poses significant risk and requires immediate attention.
action.notable.param.rule_title = DarkStrata: Critical Credential Exposure - $user$ on $dest$
action.notable.param.security_domain = identity
action.notable.param.severity = high
action.risk = 1
action.risk.param._risk_object = user
action.risk.param._risk_object_type = user
action.risk.param._risk_score = 80
alert.track = 1
cron_schedule = */5 * * * *
description = Detects new critical or high severity credential exposures from DarkStrata. Triggers notable event in ES.
dispatch.earliest_time = -10m@m
dispatch.latest_time = now
enableSched = 1
search = sourcetype="darkstrata:stix:observed-data" \
    | spath path="labels{}" output=labels \
    | where match(mvjoin(labels,","),"severity-critical") OR match(mvjoin(labels,","),"severity-high") \
    | spath path="objects.0.account_login" output=user \
    | spath path="objects.1.value" output=dest \
    | eval source_type=if(match(mvjoin(labels,","),"source:malware"),"Malware/Infostealer","Data Breach") \
    | eval severity=if(match(mvjoin(labels,","),"severity-critical"),"critical","high") \
    | eval signature="Credential Exposure: ".user." on ".dest \
    | eval app="darkstrata" \
    | table _time, user, dest, source_type, severity, signature, app

#
# Malware-Sourced Credential Detection
# Triggers when credentials sourced from malware/infostealers are detected
#
[DarkStrata - Malware Credential Detected]
action.correlationsearch.enabled = 1
action.correlationsearch.label = DarkStrata - Malware Credential
action.email.useNSSubject = 1
action.notable = 1
action.notable.param.drilldown_name = View Malware Indicators
action.notable.param.drilldown_search = sourcetype="darkstrata:stix:observed-data" labels="*source:malware*" | search user="$user$"
action.notable.param.rule_description = A credential sourced from malware (infostealer, keylogger) was detected. This indicates an active compromise of the user's device.
action.notable.param.rule_title = DarkStrata: Malware-Sourced Credential - $user$
action.notable.param.security_domain = endpoint
action.notable.param.severity = critical
action.risk = 1
action.risk.param._risk_object = user
action.risk.param._risk_object_type = user
action.risk.param._risk_score = 100
alert.track = 1
cron_schedule = */5 * * * *
description = Detects credentials sourced from malware/infostealers - indicates active device compromise.
dispatch.earliest_time = -10m@m
dispatch.latest_time = now
enableSched = 1
search = sourcetype="darkstrata:stix:observed-data" \
    | spath path="labels{}" output=labels \
    | where match(mvjoin(labels,","),"source:malware") \
    | spath path="objects.0.account_login" output=user \
    | spath path="objects.1.value" output=dest \
    | eval signature="Malware-sourced credential: ".user \
    | eval app="darkstrata" \
    | eval threat_category="malware" \
    | table _time, user, dest, signature, app, threat_category

#
# Outbound Credential Exposure (Third-Party Risk)
# Detects corporate credentials used on third-party services
#
[DarkStrata - Third Party Credential Exposure]
action.correlationsearch.enabled = 1
action.correlationsearch.label = DarkStrata - Third Party Exposure
action.email.useNSSubject = 1
action.notable = 1
action.notable.param.drilldown_name = View Third Party Exposures
action.notable.param.drilldown_search = sourcetype="darkstrata:stix:observed-data" labels="*flow:outbound*"
action.notable.param.rule_description = Corporate credentials were found exposed on third-party services. This indicates password reuse on external sites.
action.notable.param.rule_title = DarkStrata: Corporate Credential on Third-Party - $user$ on $dest$
action.notable.param.security_domain = identity
action.notable.param.severity = medium
action.risk = 1
action.risk.param._risk_object = user
action.risk.param._risk_object_type = user
action.risk.param._risk_score = 50
alert.track = 1
cron_schedule = */15 * * * *
description = Detects corporate credentials exposed on third-party services (outbound flow).
dispatch.earliest_time = -20m@m
dispatch.latest_time = now
enableSched = 1
search = sourcetype="darkstrata:stix:observed-data" \
    | spath path="labels{}" output=labels \
    | where match(mvjoin(labels,","),"flow:outbound") \
    | spath path="objects.0.account_login" output=user \
    | spath path="objects.1.value" output=dest \
    | eval signature="Third-party credential exposure: ".user." on ".dest \
    | eval app="darkstrata" \
    | stats count as exposure_count, values(dest) as affected_services by user \
    | where exposure_count > 0 \
    | table _time, user, affected_services, exposure_count

#
# Multiple Users from Same Source (Campaign Detection)
# Detects potential malware campaigns affecting multiple users
#
[DarkStrata - Potential Malware Campaign]
action.correlationsearch.enabled = 1
action.correlationsearch.label = DarkStrata - Malware Campaign
action.email.useNSSubject = 1
action.notable = 1
action.notable.param.drilldown_name = View Campaign Details
action.notable.param.drilldown_search = sourcetype="darkstrata:stix:observed-data" labels="*source:malware*" earliest=-1h
action.notable.param.rule_description = Multiple users have credentials exposed from the same malware source within a short time period, indicating a potential malware campaign.
action.notable.param.rule_title = DarkStrata: Potential Malware Campaign - $affected_user_count$ users affected
action.notable.param.security_domain = endpoint
action.notable.param.severity = high
action.risk = 1
action.risk.param._risk_score = 90
alert.track = 1
cron_schedule = 0 * * * *
description = Detects multiple users affected by malware credentials in a short time period.
dispatch.earliest_time = -1h@h
dispatch.latest_time = now
enableSched = 1
search = sourcetype="darkstrata:stix:observed-data" \
    | spath path="labels{}" output=labels \
    | where match(mvjoin(labels,","),"source:malware") \
    | spath path="objects.0.account_login" output=user \
    | stats dc(user) as affected_user_count, values(user) as affected_users \
    | where affected_user_count >= 3 \
    | eval signature="Potential malware campaign: ".affected_user_count." users affected" \
    | table _time, affected_user_count, affected_users, signature

#
# New Alert Bundle Detected
# Triggers when a new DarkStrata alert is received
#
[DarkStrata - New Alert Received]
action.email.useNSSubject = 1
alert.track = 1
cron_schedule = */5 * * * *
description = Monitors for new DarkStrata alert bundles and logs them for tracking.
dispatch.earliest_time = -10m@m
dispatch.latest_time = now
enableSched = 1
search = sourcetype="darkstrata:stix:alert" \
    | spath path="objects{}.type" output=object_types \
    | where mvfind(object_types,"report")>=0 \
    | spath path="objects{}" output=objects \
    | mvexpand objects \
    | spath input=objects path=type output=obj_type \
    | where obj_type="report" \
    | spath input=objects path=name output=alert_name \
    | spath input=objects path=published output=published \
    | spath input=objects path=labels{} output=labels \
    | eval severity=case(match(mvjoin(labels,","),"severity-critical"),"critical", match(mvjoin(labels,","),"severity-high"),"high", match(mvjoin(labels,","),"severity-medium"),"medium", match(mvjoin(labels,","),"severity-low"),"low", 1=1,"info") \
    | table _time, alert_name, published, severity


# =============================================================================
# LOOKUP GENERATION SEARCHES
# Generate CSV lookups for threat intel correlation
# =============================================================================

#
# Generate email lookup for ES threat matching
#
[DarkStrata - Generate Email Lookup]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 0 */4 * * *
description = Generates email lookup file for threat intel matching. Runs every 4 hours.
dispatch.earliest_time = -30d@d
dispatch.latest_time = now
enableSched = 1
search = sourcetype="darkstrata:stix:observed-data" \
    | spath path="objects.0.account_type" output=account_type \
    | where account_type="email" \
    | spath path="objects.0.account_login" output=email \
    | spath path="labels{}" output=labels \
    | eval weight=case(match(mvjoin(labels,","),"severity-critical"),100, match(mvjoin(labels,","),"severity-high"),80, match(mvjoin(labels,","),"severity-medium"),60, 1=1, 40) \
    | stats max(weight) as weight, latest(_time) as last_seen by email \
    | eval threat_key=email, description="Compromised email from DarkStrata" \
    | table email, threat_key, description, weight, last_seen \
    | outputlookup darkstrata_email_intel.csv
