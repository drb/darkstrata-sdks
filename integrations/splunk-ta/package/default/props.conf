# DarkStrata Technology Add-on - Props Configuration
# Defines sourcetypes and field extractions for DarkStrata threat intelligence

#
# STIX Observed-Data Sourcetype
# Used for individual compromised credential indicators
#
[darkstrata:stix:observed-data]
DATETIME_CONFIG =
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%6N%:z
TIME_PREFIX = "modified"\s*:\s*"
MAX_TIMESTAMP_LOOKAHEAD = 40
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
KV_MODE = json
TRUNCATE = 999999

# Extract key fields from JSON
FIELDALIAS-stix_id = id AS stix_id
FIELDALIAS-stix_type = type AS stix_type

# Extract user account from nested objects
EVAL-user = json_extract(objects, "0.account_login")
EVAL-user_type = json_extract(objects, "0.account_type")
EVAL-dest = json_extract(objects, "1.value")

# Extract labels for filtering
EVAL-source_type = if(match(labels, "source:malware"), "malware", if(match(labels, "source:breach"), "breach", "unknown"))
EVAL-flow_direction = if(match(labels, "flow:inbound"), "inbound", if(match(labels, "flow:outbound"), "outbound", "unknown"))

# CIM Threat Intelligence mapping
FIELDALIAS-threat_match_type = type AS threat_match_type
EVAL-threat_key = json_extract(objects, "0.account_login")
EVAL-threat_match_value = json_extract(objects, "1.value")

# CIM Authentication mapping (for credential exposure events)
FIELDALIAS-action = "success" AS action
EVAL-app = "darkstrata"
EVAL-authentication_method = "compromised_credential"
EVAL-signature = "Credential Exposure: ".json_extract(objects, "0.account_login")." on ".json_extract(objects, "1.value")


#
# STIX Alert Sourcetype
# Used for credential exposure alert bundles (contains report + indicators)
#
[darkstrata:stix:alert]
DATETIME_CONFIG =
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%6N%:z
TIME_PREFIX = "published"\s*:\s*"
MAX_TIMESTAMP_LOOKAHEAD = 40
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
KV_MODE = json
TRUNCATE = 999999

# Extract bundle-level fields
FIELDALIAS-bundle_id = id AS bundle_id
FIELDALIAS-bundle_type = type AS bundle_type

# Extract report details from objects array
EVAL-alert_name = mvindex(json_extract(objects, "{}.name"), 0)
EVAL-alert_description = mvindex(json_extract(objects, "{}.description"), 0)
EVAL-alert_severity = case(match(mvjoin(json_extract(objects, "{}.labels"), ","), "severity-critical"), "critical", match(mvjoin(json_extract(objects, "{}.labels"), ","), "severity-high"), "high", match(mvjoin(json_extract(objects, "{}.labels"), ","), "severity-medium"), "medium", match(mvjoin(json_extract(objects, "{}.labels"), ","), "severity-low"), "low", 1=1, "info")

# Count indicators in bundle
EVAL-indicator_count = mvcount(mvfilter(match(json_extract(objects, "{}.type"), "observed-data|indicator")))


#
# Credential Exposure Sourcetype (future: data-intelligence endpoint)
#
[darkstrata:credential:exposure]
DATETIME_CONFIG =
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%6N%:z
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
KV_MODE = json
TRUNCATE = 999999

# CIM Identity Management mapping
EVAL-identity_type = "user"
FIELDALIAS-identity = email AS identity


#
# Default catch-all for DarkStrata events
#
[darkstrata]
DATETIME_CONFIG =
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%6N%:z
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
KV_MODE = json
