# DarkStrata Technology Add-on - Macros Configuration
# Reusable search components for DarkStrata threat intelligence

#
# Base search for DarkStrata observed-data events
#
[darkstrata_observed_data]
definition = sourcetype="darkstrata:stix:observed-data"
description = Base search for DarkStrata observed-data events
iseval = 0

#
# Base search for DarkStrata alert bundles
#
[darkstrata_alerts]
definition = sourcetype="darkstrata:stix:alert"
description = Base search for DarkStrata alert bundle events
iseval = 0

#
# Extract user and domain from observed-data
#
[darkstrata_extract_fields]
definition = spath path="objects.0.account_login" output=user | spath path="objects.0.account_type" output=user_type | spath path="objects.1.value" output=dest
description = Extract user, user_type, and dest (domain) from observed-data events
iseval = 0

#
# Extract labels and derive severity/source/flow
#
[darkstrata_extract_labels]
definition = spath path="labels{}" output=labels | eval source_type=if(match(mvjoin(labels,","),"source:malware"),"malware","breach") | eval flow_direction=if(match(mvjoin(labels,","),"flow:inbound"),"inbound","outbound") | eval severity=case(match(mvjoin(labels,","),"severity-critical"),"critical", match(mvjoin(labels,","),"severity-high"),"high", match(mvjoin(labels,","),"severity-medium"),"medium", match(mvjoin(labels,","),"severity-low"),"low", 1=1,"info")
description = Extract and parse labels to derive source_type, flow_direction, and severity
iseval = 0

#
# Filter for critical and high severity events
#
[darkstrata_high_severity]
definition = spath path="labels{}" output=labels | where match(mvjoin(labels,","),"severity-critical") OR match(mvjoin(labels,","),"severity-high")
description = Filter for critical and high severity credential exposures
iseval = 0

#
# Filter for malware-sourced credentials
#
[darkstrata_malware_source]
definition = spath path="labels{}" output=labels | where match(mvjoin(labels,","),"source:malware")
description = Filter for credentials sourced from malware/infostealers
iseval = 0

#
# Filter for breach-sourced credentials
#
[darkstrata_breach_source]
definition = spath path="labels{}" output=labels | where match(mvjoin(labels,","),"source:breach")
description = Filter for credentials sourced from data breaches
iseval = 0

#
# Filter for inbound flow (corporate assets affected)
#
[darkstrata_inbound_flow]
definition = spath path="labels{}" output=labels | where match(mvjoin(labels,","),"flow:inbound")
description = Filter for inbound credential exposures (corporate email domains compromised)
iseval = 0

#
# Filter for outbound flow (third-party exposure)
#
[darkstrata_outbound_flow]
definition = spath path="labels{}" output=labels | where match(mvjoin(labels,","),"flow:outbound")
description = Filter for outbound credential exposures (corporate credentials on third-party sites)
iseval = 0

#
# Calculate threat weight from severity
#
[darkstrata_threat_weight]
definition = eval threat_weight=case(severity="critical",100, severity="high",80, severity="medium",60, severity="low",40, 1=1,20)
description = Calculate threat weight (0-100) from severity level
iseval = 0

#
# Full field extraction pipeline
#
[darkstrata_full_extract]
definition = `darkstrata_extract_fields` | `darkstrata_extract_labels` | `darkstrata_threat_weight`
description = Complete field extraction pipeline for observed-data events
iseval = 0

#
# Lookup email in threat intel
#
[darkstrata_email_lookup(1)]
args = email_field
definition = lookup darkstrata_email_intel_lookup email as $email_field$ OUTPUT threat_key, description as threat_description, weight as threat_weight
description = Look up email address in DarkStrata threat intel
iseval = 0

#
# Lookup domain in threat intel
#
[darkstrata_domain_lookup(1)]
args = domain_field
definition = lookup darkstrata_domain_intel_lookup domain as $domain_field$ OUTPUT threat_key, description as threat_description, weight as threat_weight
description = Look up domain in DarkStrata threat intel
iseval = 0

#
# Lookup user in threat intel
#
[darkstrata_user_lookup(1)]
args = user_field
definition = lookup darkstrata_user_intel_lookup user as $user_field$ OUTPUT threat_key, description as threat_description, weight as threat_weight
description = Look up user in DarkStrata threat intel
iseval = 0

#
# Get credential exposure summary statistics
#
[darkstrata_summary_stats]
definition = `darkstrata_observed_data` | `darkstrata_full_extract` | stats count as total_exposures, dc(user) as unique_users, dc(dest) as unique_domains, avg(threat_weight) as avg_threat_weight by source_type, flow_direction, severity
description = Summary statistics for credential exposures
iseval = 0
